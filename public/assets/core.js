var j=jQuery;var Quadro={views:{}};var LoginView=Backbone.View.extend({className:"login",template:JST["home/login"],initialize:function(){_.bindAll(this,"render")},render:function(){j(this.el).html(this.template());return this}});var WorkspaceView=Backbone.View.extend({className:"workspace",template:JST["home/workspace"],events:{"click .new":"createSticky","click .boards":"openBoardsWindow","click .feedback":"openUserVoice","click .board_title":"changeBoardTitle","mouseenter li > a":"menuHoverFx","mouseleave li > a":"menuLeaveFx"},initialize:function(){_.bindAll(this,"render","createSticky","addOne","addAll","manipulateClipboard","openBoardsWindow","openUserVoice","changeBoardTitle");Stickies.bind("add",this.addOne);Stickies.bind("reset",this.addAll);Boards.bind("change:title",this.didChangeTitle);StickyContextMenuView.initialize();j(document).bind("paste",this.manipulateClipboard)},setReadonly:function(){j(this.el).undelegate(".board_title","click")},changeBoardTitle:function(a){var b=prompt("Enter a new title:");if(b!==null){currentBoard.set({title:b}).save()}},didChangeTitle:function(a,b){j(".board_title").text(b);j(".boards_window").find("li[data-id="+a.id+"] .title").text(b)},menuHoverFx:function(a){j(a.currentTarget).animate({color:"#fff"},"fast")},menuLeaveFx:function(a){j(a.currentTarget).animate({color:"#ccc"},"fast")},openBoardsWindow:function(a){a.preventDefault();if(_.isUndefined(this.boardsView)){this.boardsView=new BoardsView;j(this.boardsView.render().el).prependTo("#app")}this.boardsView.open()},openUserVoice:function(a){a.preventDefault();UserVoice.showPopupWidget()},manipulateClipboard:function(b){var d=b.originalEvent.clipboardData,a=d.getData("text/html")||d.getData("text/plain"),c=j("<p/>").html(a).text();j(b.target).append(c);b.preventDefault()},addOne:function(c){var b=new StickyView({model:c}).render();var a=j(b.el).appendTo(".stickies").css({top:c.get("position_y"),left:c.get("position_x")}).show()},addAll:function(){Stickies.each(this.addOne)},createSticky:function(b){var a=new StickyView({model:new Sticky}).render();j(a.el).appendTo(".stickies").fadeIn().css("z-index",zIndexMax());b.preventDefault()},render:function(){j(this.el).html(this.template());if(!Quadro.readonly){this.shareMenuView=new ShareMenuView().render();j(this.el).find(".right").parent().before(this.shareMenuView.el)}return this}});var ShareMenuView=Backbone.View.extend({tagName:"li",template:JST["boards/share"],events:{"click .share":"toggleSubmenu","click #share_public":"makeBoardPublic","keypress #username":"lookupUsername","click .destroy_relationship":"destroyCollaboration"},initialize:function(){_.bindAll(this,"render","toggleSubmenu","makeBoardPublic","lookupUsername","destroyCollaboration");currentBoard.collaborators.bind("add",this.render)},destroyCollaboration:function(c){var b=j(c.currentTarget).parent(),d=b.data("id"),a=currentBoard.collaborators.get(d);a.destroy({success:function(){b.fadeOut("fast",function(){b.remove()})}});currentBoard.collaborators.remove(a);c.preventDefault()},lookupUsername:function(c){if(c.keyCode==13){var d=j(c.currentTarget).val(),b=(d!==""&&d!==Quadro.nickname),a=currentBoard.collaborators.detect(function(e){return e.get("nickname").toLowerCase()==d.toLowerCase()});if(!a&&b){currentBoard.collaborators.create({username:d})}}},toggleSubmenu:function(a){a.preventDefault();j(this.el).find(".share_menu").fadeToggle("fast")},makeBoardPublic:function(b){var a=b.currentTarget.checked;currentBoard.set({share_public:a}).save()},render:function(){var a=j(this.el).find(".share_menu:visible").length;j(this.el).html(this.template(currentBoard.toJSON()));if(arguments.length&&a){j(this.el).find(".share_menu").show()}return this}});var Sticky=Backbone.Model.extend({defaults:{title:"Untitled",content:"Click here to start writing something useful. You can also change the background color using the right mouse button.",position_x:100,position_y:100,color:"yellow"},url:function(){return"/boards/"+currentBoard.id+"/stickies"+(this.isNew()?"":"/"+this.id)},toJSON:function(){var a=_.clone(this.attributes);return _.extend(a,{cid:_.bind(function(){return this.cid.match(/\d+/)[0]},this),formattedContent:function(){return formatContent(this.content)}})}});var StickyCollection=Backbone.Collection.extend({model:Sticky}),Stickies=window.Stickies=new StickyCollection;Stickies.url=function(){return"/boards/"+currentBoard.id+"/stickies"};var StickyView=Backbone.View.extend({className:"sticky",template:JST["stickies/sticky"],events:{"click .remove":"remove","focus .title, .content":"setContentEditable","blur .title, .content":"unsetContentEditable","keypress .title":"didChangeTitle",contextmenu:"openContextMenu",dragstop:"updateStickyPosition",dragstart:"closeContextMenu"},initialize:function(){_.bindAll(this,"render","setContentEditable","unsetContentEditable","remove","didChangeTitle","openContextMenu","closeContextMenu")},openContextMenu:function(a){a.preventDefault();StickyContextMenuView.context(this).open(a.pageX,a.pageY)},closeContextMenu:function(){StickyContextMenuView.close()},didChangeTitle:function(a){return a.which!=13},updateStickyPosition:function(b,c){var a=this;this.model.set({position_x:c.offset.left,position_y:c.offset.top}).save({},{error:function(d,e){if(e.statusText!=="abort"){a.close()}}})},setContentEditable:function(a){j(a.currentTarget).attr("contenteditable","true")},unsetContentEditable:function(b){var a=[],c=j(this.el).find(".title").text();j(b.currentTarget).attr("contenteditable","false");j(this.el).find(".content p").each(function(){a.push(j(this).text())});a=a.join("\n");if(this.model.get("title")!==c||this.model.get("content")!==a){this.model.set({title:c,content:a}).save()}},close:function(){j(this.el).fadeOut(function(){j(this).remove()})},remove:function(b){var a=this;if(b&&"preventDefault" in b){b.preventDefault()}this.model.destroy({success:function(){a.close()}});if(this.model.isNew()){this.close()}},render:function(){j(this.el).addClass(this.model.get("color")).html(this.template(this.model.toJSON())).css("position","absolute").draggable({containment:"window",cancel:".title, .content",stack:".sticky"});if(Quadro.readonly){j(this.el).unbind();j(this.el).find(".remove").remove()}if(j(".sticky:last").hasClass("even")==false){j(this.el).addClass("even")}return this}});var StickyContextMenuView={availableColors:["blue","green","pink","purple","gray"],template:JST["stickies/colors"],initialize:function(){_.bindAll(this,"changeColor","close");this.el=j(this.template()).prependTo("#app");this.el.find("li").bind("click",this.changeColor);j(document).bind("click",this.close)},changeColor:function(c){var b=this,a=j(c.currentTarget).data("color");_.each(this.availableColors,function(d){j(b.sticky.el).removeClass(d)});this.sticky.model.set({color:a}).save();j(this.sticky.el).addClass(this.sticky.model.get("color"))},context:function(a){this.sticky=a;return this},open:function(a,b){this.el.css({top:b,left:a,zIndex:998}).fadeIn(1)},close:function(){this.el.fadeOut("fast")}};var Collaborator=Backbone.Model.extend({}),CollaboratorCollection=Backbone.Collection.extend({model:Collaborator});var Board=Backbone.Model.extend({urlRoot:"/boards",defaults:{title:"Untitled",share_public:false},initialize:function(){this.collaborators=new CollaboratorCollection;this.collaborators.url="/boards/"+this.id+"/collaborators";this.collaborators.reset(this.attributes.collaborators)},toJSON:function(){var a=_.clone(this.attributes);a.collaborators=this.collaborators.toJSON();return a}});var BoardCollection=Backbone.Collection.extend({model:Board}),Boards=window.Boards=new BoardCollection,currentBoard=null;var BoardsView=Backbone.View.extend({className:"boards_window",template:JST["boards/boards"],events:{"click .ui-overlay":"close","click .open_board":"openBoard","click .new_board":"createBoard","click .destroy_board":"removeBoard"},initialize:function(){_.bindAll(this,"render","close","escKey","openBoard","createBoard","removeBoard");j(document).bind("keyup",this.escKey)},escKey:function(a){if(a.keyCode==27){this.close()}},openBoard:function(b){var c=j(b.currentTarget).parents("li").data("id"),a=this;currentBoard=Boards.get(c);Stickies.fetch({success:function(e,d){j(".stickies").empty();j(".board_title").text(currentBoard.get("title"));e.trigger("reset");a.close()}});Quadro.views.workspaceView.shareMenuView.render(true);b.preventDefault()},createBoard:function(a){var b=prompt("Enter a title:")||"Untitled";Boards.create({title:b},{success:function(d,c,f){var e=JST["boards/board"].call(d.toJSON());j(e).css("display","none").appendTo(".boards_window ul").slideDown()}});a.preventDefault()},removeBoard:function(c){var a=j(c.currentTarget),e=a.parent().data("id"),b=Boards.get(e),d=confirm("Are you sure?");if(d){b.destroy({success:function(g,f){a.parent().slideUp()},error:function(g,i,h){var f=JSON.parse(i.responseText);alert(f.message)}})}c.preventDefault()},open:function(){j(this.el).show()},close:function(){j(this.el).hide()},render:function(){this.boards=Boards.map(function(a){return JST["boards/board"].call(a.toJSON())});j(this.el).html(this.template({boards:this.boards}));return this}});var currentRequests={};j.ajaxPrefilter(function(a,d,c){var b=j("meta[name='csrf-token']").attr("content");if(currentRequests[a.url]){currentRequests[a.url].abort()}c.setRequestHeader("X-CSRF-Token",b);currentRequests[a.url]=c});j.ajaxSetup({beforeSend:function(){if(j(".workspace:visible").length){j(".mini_loader").css("visibility","visible")}},complete:function(){if(j(".workspace:visible").length){j(".mini_loader").css("visibility","hidden")}}});window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;console.log(Array.prototype.slice.call(arguments))}};function formatContent(a){var b=j("<div/>");_.each(a.split("\n"),function(c){j("<p/>").text(c).appendTo(b)});return b.html()}function zIndexMax(){var a=0;j(".sticky").each(function(){var b=parseInt(j(this).css("z-index"));if(b>a){a=b}});return a+1}j(function(){_.extend(Quadro,{readonly:j(document.body).data("readonly"),board_id:j(document.body).data("board-id")});if(Quadro.authenticated||Quadro.readonly){currentBoard=Boards.get(Quadro.board_id)||Boards.first();Quadro.views.workspaceView=new WorkspaceView().render();j(Quadro.views.workspaceView.el).prependTo("#app");if(Quadro.readonly){Quadro.views.workspaceView.setReadonly()}Stickies.trigger("reset")}else{Quadro.views.loginView=new LoginView().render();j(Quadro.views.loginView.el).prependTo("#app")}j(window).load(function(){j("#loading").fadeOut()})});