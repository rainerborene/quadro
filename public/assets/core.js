var j=jQuery;var Quadro={views:{}};var LoginView=Backbone.View.extend({className:"login",template:JST["home/login"],initialize:function(){_.bindAll(this,"render")},render:function(){j(this.el).html(this.template());return this}});var WorkspaceView=Backbone.View.extend({className:"workspace",template:JST["home/workspace"],events:{"click .new":"createSticky","click .boards":"openBoardsWindow","click .feedback":"openUserVoice","click .quick-view":"toggleQuickView"},initialize:function(){_.bindAll(this,"render","createSticky","addOne","addAll","manipulateClipboard","openBoardsWindow","openUserVoice","toggleQuickView");Stickies.bind("add",this.addOne);Stickies.bind("reset",this.addAll);Boards.bind("change:title",this.didChangeTitle);StickyContextMenuView.initialize();j(document).bind("paste",this.manipulateClipboard);j(document).bind("dblclick",this.createSticky);Quadro.views.shareMenuView=new ShareMenuView();Quadro.views.notificationView=new NotificationView()},toggleQuickView:function(c){var b=j(c.currentTarget),a=j(this.el).find(".topbar");if(a.position().top<0){b.animate({opacity:0.2});a.stop().animate({top:0})}else{a.stop().animate({top:(a.height()+4)*-1});b.animate({opacity:0.5})}},setReadonly:function(){j("html, body").css("overflow","auto")},didChangeTitle:function(a,b){j(".board-list").find("li[data-id="+a.id+"] .item-title").text(b)},openBoardsWindow:function(b){var a=j(b.currentTarget);b.preventDefault();if(_.isUndefined(this.boardsView)){this.boardsView=new BoardsView().render();j(this.boardsView.el).appendTo("#app")}if(a.parent().next().hasClass("active")){a.parent().next().find("a").trigger("click")}this.boardsView.open()},openUserVoice:function(a){a.preventDefault();UserVoice.showPopupWidget()},manipulateClipboard:function(a){var b=a.target.tagName=="BR"?j(a.target).parent():j(a.target);setTimeout(function(){b.find(":not(p,br)").each(function(){j(this).replaceWith("<p>"+j(this).text()+"</p>")})},1)},addOne:function(c){var b=new StickyView({model:c}).render();var a=j(b.el).appendTo(".stickies").css({top:c.get("position_y"),left:c.get("position_x")}).show()},addAll:function(){Stickies.each(this.addOne);setTimeout(function(){j(".sticky").css("height","auto")},1)},createSticky:function(c){if(Quadro.readonly){return}var a=new Sticky(),b=new StickyView({model:a}).render(),d=zIndexMax();if(c.type=="dblclick"){if(c.target!=document.body){return}j(b.el).css({top:c.layerY,left:c.layerX})}else{j(b.el).css({left:(j(window).width()-340)*Math.random(),top:Math.max(60,parseInt((j(window).height()-250)*Math.random()))})}a.set({position_x:parseInt(j(b.el).css("left")),position_y:parseInt(j(b.el).css("top")),z_index:d});j(b.el).appendTo(".stickies").css("zIndex",d).fadeIn(function(){j(this).css({height:"auto"})});c.preventDefault()},render:function(){j(this.el).html(this.template());if(!Quadro.readonly){Quadro.views.shareMenuView.render();Quadro.views.notificationView.render();j(this.el).find(".feedback").parent().before(Quadro.views.shareMenuView.el);j(this.el).append(Quadro.views.notificationView.el)}return this}});var ShareMenuView=Backbone.View.extend({tagName:"li",className:"share-menu",template:JST["boards/share"],events:{"click .share":"toggleSubmenu","click #share-public":"makeBoardPublic","click .delete-collaboration":"destroyCollaboration","keypress #username":"lookupUsername","submit form":"cancelSubmit"},initialize:function(){_.bindAll(this,"render","toggleSubmenu","makeBoardPublic","lookupUsername","destroyCollaboration","closeSubmenu");j(document).bind("click",this.closeSubmenu)},cancelSubmit:function(a){a.preventDefault()},closeSubmenu:function(a){if(!j(a.target).parents(".topbar").length){j(this.el).find(".popover:not(:animated)").fadeOut("fast");j(this.el).removeClass("active")}},destroyCollaboration:function(c){var b=j(c.currentTarget).parent(),d=b.data("id"),a=currentBoard.collaborators.get(d);j(c.currentTarget).attr("disabled","disabled");a.destroy({success:function(){b.fadeOut("fast",function(){b.remove()})}});currentBoard.collaborators.remove(a);c.preventDefault()},lookupUsername:function(e){if(e.keyCode==13){var d=this,a=j(e.currentTarget),f=a.val().replace(/@/g,""),c=(f!==""&&f!==Quadro.nickname),b=currentBoard.collaborators.detect(function(g){return g.get("nickname").toLowerCase()==f.toLowerCase()});if(!b&&c){a.attr("disabled","disabled");currentBoard.collaborators.create({username:f},{error:function(){a.removeAttr("disabled").css({backgroundColor:"#D83A2E",color:"#ffffff"}).animate({backgroundColor:"#ffffff",color:"#808080"},"slow").trigger("focus")},success:function(i,h,m){var k=JST["boards/collaborator"],o=j(".collaborators"),n=j("#username"),l=j(k({item:h})),g=Math.abs(o[0].scrollHeight-o.height())-o.scrollTop()+25;l.css("display","none");o.append(l).animate({scrollTop:"+="+g},"slow");l.fadeIn();n.val("").removeAttr("disabled")}})}}},toggleSubmenu:function(a){a.preventDefault();j(this.el).find(".popover").fadeToggle("fast");j(this.el).toggleClass("active")},makeBoardPublic:function(b){var a=b.currentTarget.checked;currentBoard.set({share_public:a}).save()},render:function(){j(this.el).html(this.template(currentBoard.toJSON()));return this}});var Sticky=Backbone.Model.extend({defaults:{content:"Untitled\n\nClick here to start writing something useful. You can also change the background color using the right mouse button.",position_x:100,position_y:100,color:"yellow",z_index:0},url:function(){return"/boards/"+currentBoard.id+"/stickies"+(this.isNew()?"":"/"+this.id)},toJSON:function(){var a=_.clone(this.attributes);return _.extend(a,{cid:_.bind(function(){return this.cid.match(/\d+/)[0]},this),formattedContent:function(){return formatContent(this.content)}})}});var StickyCollection=Backbone.Collection.extend({model:Sticky}),Stickies=window.Stickies=new StickyCollection;Stickies.url=function(){return"/boards/"+currentBoard.id+"/stickies"};var StickyView=Backbone.View.extend({className:"sticky",template:JST["stickies/sticky"],events:{"click .remove":"remove","focus .content":"setContentEditable","blur .content":"unsetContentEditable",contextmenu:"openContextMenu",dragstop:"updateStickyPosition",dragstart:"closeContextMenu",click:"bringToFront"},initialize:function(){_.bindAll(this,"render","setContentEditable","unsetContentEditable","remove","openContextMenu","closeContextMenu","bringToFront")},bringToFront:function(c){var b=j(this.el).css("z-index"),a=zIndexMax();if(parseInt(b)!=a-1&&isOverlapping(j(this.el))){this.model.set({z_index:a}).save();j(this.el).css("zIndex",a)}},openContextMenu:function(a){a.preventDefault();StickyContextMenuView.context(this).open(a.pageX,a.pageY)},closeContextMenu:function(){StickyContextMenuView.close()},updateStickyPosition:function(b,c){var a=this;this.model.set({position_x:c.offset.left,position_y:c.offset.top}).save({},{error:function(d,e){if(e.statusText!=="abort"){a.close()}}})},setContentEditable:function(b){var a=j(b.currentTarget);if(a.text().replace(/\n+/,"")==this.model.defaults.content.replace(/\n+/,"")){a.text("");setSelection(b.currentTarget)}a.removeClass("unselectable").attr("contenteditable","true");b.preventDefault()},unsetContentEditable:function(c){var b=[],a=j(this.el).find(".content p");j(c.currentTarget).addClass("unselectable").attr("contenteditable","false");if(a.length){a.each(function(){b.push(j(this).text())});b=b.join("\n")}else{b=j(this.el).find(".content").text()}if(!j.trim(b).length){b=this.model.defaults.content;j(this.el).find(".content").empty().append(j("<p/>").text(b))}if(this.model.get("content")!==b){this.model.set({content:b}).save()}},close:function(){j(this.el).fadeOut(function(){j(this).remove()})},remove:function(b){var a=this;if(b&&"preventDefault" in b){b.preventDefault()}this.model.destroy({success:function(){a.close()}});if(this.model.isNew()){this.close()}},render:function(){j(this.el).addClass(this.model.get("color")).html(this.template(this.model.toJSON())).css({position:"absolute",zIndex:this.model.get("z_index")}).draggable({containment:"window",cancel:".content",stack:".sticky"});if(Quadro.readonly){j(this.el).unbind();j(this.el).find(".remove").remove();j(this.el).find(".content").removeClass("unselectable")}if(j(".sticky:last").hasClass("even")==false){j(this.el).addClass("even")}return this}});var StickyContextMenuView={availableColors:["blue","green","pink","purple","gray"],template:JST["stickies/colors"],initialize:function(){_.bindAll(this,"changeColor","close");this.el=j(this.template()).prependTo("#app");this.el.find("li").bind("click",this.changeColor);j(document).bind("click",this.close)},changeColor:function(c){var b=this,a=j(c.currentTarget).data("color");_.each(this.availableColors,function(d){j(b.sticky.el).removeClass(d)});this.sticky.model.set({color:a}).save();j(this.sticky.el).addClass(this.sticky.model.get("color"))},context:function(a){this.sticky=a;return this},open:function(a,b){this.el.css({top:b,left:a,zIndex:998}).fadeIn(1)},close:function(){this.el.fadeOut("fast")}};var Collaborator=Backbone.Model.extend({}),CollaboratorCollection=Backbone.Collection.extend({model:Collaborator});var Board=Backbone.Model.extend({urlRoot:"/boards",defaults:{title:"Untitled",share_public:false},initialize:function(){this.collaborators=new CollaboratorCollection;this.collaborators.url="/boards/"+this.id+"/collaborators";this.collaborators.reset(this.attributes.collaborators)},toJSON:function(){var a=_.clone(this.attributes);a.collaborators=this.collaborators.toJSON();return a}});var BoardCollection=Backbone.Collection.extend({model:Board}),Boards=window.Boards=new BoardCollection,currentBoard=null;var BoardsView=Backbone.View.extend({template:JST["boards/boards"],className:"unselectable",events:{"click .new-board":"newBoard","blur .title-field":"saveWhenBlur","keypress .title-field":"saveWhenEnter","click .remove-board":"removeBoard","click .open-board":"openBoard","click .board-list li":"selectItem","dblclick .board-list li":"changeTitle","click .close, .overlay":"close"},initialize:function(){_.bindAll(this,"render","openBoard","close","newBoard","saveWhenBlur","saveWhenEnter","saveBoard","removeBoard","changeTitle","selectItem","escKey");j(document).bind("keyup",this.escKey)},selectItem:function(a){j(a.currentTarget).siblings().removeClass("selected");j(a.currentTarget).addClass("selected");j(this.el).find("button[disabled]").removeAttr("disabled")},escKey:function(a){if(a.keyCode==27){this.close()}},openBoard:function(d){var b=j(".board-list").find(".selected"),a=j(d.currentTarget),c=this;if(b.length){var e=b.data("id");currentBoard=Boards.get(e);a.attr("disabled","disabled");Stickies.fetch({success:function(g,f){j(".stickies").empty();updateWindowTitle();g.trigger("reset");a.removeAttr("disabled");c.close()}});Quadro.views.shareMenuView.render()}},changeTitle:function(c){var a=j(this.make("input",{"class":"title-field",maxlength:28})),b=j(c.currentTarget),d=b.attr("data-id");a.val(b.find(".item-title").text());b.find(".item-title").replaceWith(a);b.data("replaced",false);a.focus()},newBoard:function(d){var b=JST["boards/board"](),a=this.make("input",{"class":"title-field",maxlength:28}),c=j(b);j(".board-list").find(".selected").removeClass("selected");c.css("display","none").find(".item-title").replaceWith(a).end().appendTo(".board-list").trigger("click").slideDown();c.find("input").focus()},saveWhenBlur:function(a){this.saveBoard(j(a.currentTarget))},saveWhenEnter:function(a){if(a.type=="keypress"&&a.keyCode=="13"){this.saveBoard(j(a.currentTarget))}},saveBoard:function(a){var d=a.parent(),e=a.val()||"Untitled",f=a.parent().attr("data-id"),c=j("<span/>",{"class":"item-title",text:e});if(a.parent().data("replaced")){return}var b={success:function(h,g,i){d.attr("data-id",g.id);if(g.id==currentBoard.id){currentBoard.set({title:g.title});updateWindowTitle()}},error:function(){d.parent().slideUp()}};a.parent().data("replaced",true);a.replaceWith(c);if(f==""){Boards.create({title:e},b)}else{Boards.get(f).save({title:e},b)}},removeBoard:function(d){var b=j(".board-list").find(".selected"),a=j(d.currentTarget);if(b.length){var f=b.data("id"),c=Boards.get(f),e=confirm("Are you sure?");if(e){a.attr("disabled","disabled");c.destroy({success:function(h,g){b.slideUp();a.removeAttr("disabled")},error:function(h,k,i){var g=JSON.parse(k.responseText);alert(g.message)}})}}d.preventDefault()},open:function(){var a=j(this.el);j(".boards").parent().addClass("active");a.find(".overlay").css("display","none").fadeIn("fast",function(){a.find(".modal").fadeIn("fast")});return false},close:function(){var a=j(this.el);a.find(".modal").fadeOut("fast",function(){a.find(".overlay").fadeOut("fast");j(".boards").parent().removeClass("active")});return false},render:function(){this.boards=Boards.map(function(a){return JST["boards/board"].call(a.toJSON())});j(this.el).html(this.template({boards:this.boards}));j(this.el).find(".modal").css({position:"absolute",left:(j(window).width()-380)/2}).draggable({containment:"window",handle:".modal-header",cancel:".close"});return this}});if(location.hostname.match(/(quadro.dev|localhost)/)&&!_.isUndefined(Pusher)){Pusher.log=function(a){if(window.console&&window.console.log){window.console.log(a)}}}var NotificationView=Backbone.View.extend({className:"alert-message warning",template:JST["notifications/notification"],pool:[],events:{"click .close":"close"},initialize:function(){_.bindAll(this,"render","open","openWithMessage","close","redraw");j(window).bind("resize",this.redraw)},redraw:function(){var a=Math.max(0,(j(window).width()-640)/2);j(this.el).css("left",a)},openWithMessage:function(b,a){this.pool.push({message:b,type:a||"warning"});this.open()},open:function(){if(j(this.el).is(":visible")){return}var a=this.pool.shift();if(!_.isUndefined(a)){j(this.el).find("p").html(a.message).end().removeClass("error").removeClass("warning").removeClass("info").addClass(a.type);j(this.el).slideDown("slow");this.timeoutId=setTimeout(this.close,4000)}},close:function(a){if(!_.isUndefined(a)){a.preventDefault()}clearTimeout(this.timeoutId);j(this.el).slideUp("slow",this.open)},render:function(){j(this.el).html(this.template());j(window).trigger("resize");return this}});function showMessage(c,b){var a=Quadro.views.notificationView;return a.openWithMessage(c,b)}var currentRequests={};j.ajaxPrefilter(function(a,d,c){var b=j("meta[name='csrf-token']").attr("content");if(currentRequests[a.url]){currentRequests[a.url].abort()}c.setRequestHeader("X-CSRF-Token",b);currentRequests[a.url]=c});j.ajaxSetup({beforeSend:function(){if(j(".workspace:visible").length){j(".mini-loader").css("display","block")}},complete:function(){if(j(".workspace:visible").length){j(".mini-loader").css("display","none")}}});window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;console.log(Array.prototype.slice.call(arguments))}};function formatContent(a){var b=j("<div/>");_.each(a.split("\n"),function(c){var d=j("<p/>");if(c==""){d.html("<br>")}else{d.text(c)}d.appendTo(b)});return b.html()}function zIndexMax(){var a=0;j(".sticky").each(function(){var b=parseInt(j(this).css("z-index"));if(b>a){a=b}});return a+1}function setSelection(a){setTimeout(function(){var c,b;if(window.getSelection&&document.createRange){b=document.createRange();b.selectNodeContents(a);b.collapse(true);c=window.getSelection();c.removeAllRanges();c.addRange(b)}else{if(document.body.createTextRange){b=document.body.createTextRange();b.moveToElementText(a);b.collapse(true);b.select()}}},1)}function isOverlapping(c){var d=j(".sticky").not(c),b=c.offset(),a=false;d.each(function(){var e=j(this).offset();if(Math.abs(e.top-b.top)<=j(this).outerHeight()&&Math.abs(e.left-b.left)<=j(this).outerWidth()){a=true}});return a}function updateWindowTitle(){document.title=(currentBoard.get("title")+" • Quadro")}j(function(){_.extend(Quadro,{readonly:j("#app").data("readonly"),board_id:j("#app").data("board-id")});if(Quadro.authenticated||Quadro.readonly){currentBoard=Boards.get(Quadro.board_id)||Boards.first();Quadro.views.workspaceView=new WorkspaceView().render();j(Quadro.views.workspaceView.el).prependTo("#app");if(Quadro.readonly){Quadro.views.workspaceView.setReadonly()}updateWindowTitle();Stickies.trigger("reset");j(window).load(function(){j("#loading").fadeOut()})}else{Quadro.views.loginView=new LoginView().render();j(Quadro.views.loginView.el).prependTo("#app")}});