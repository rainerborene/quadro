var j=jQuery;var Quadro={views:{}};var LoginView=Backbone.View.extend({className:"login",template:JST["home/login"],initialize:function(){_.bindAll(this,"render")},render:function(){j(this.el).html(this.template());return this}});var WorkspaceView=Backbone.View.extend({className:"workspace",template:JST["home/workspace"],events:{"click .new":"createSticky","click .boards":"openBoardsWindow","click .feedback":"openUserVoice","click .board_title":"changeBoardTitle","mouseenter li > a":"menuHoverFx","mouseleave li > a":"menuLeaveFx"},initialize:function(){_.bindAll(this,"render","createSticky","addOne","addAll","manipulateClipboard","openBoardsWindow","openUserVoice","changeBoardTitle");Stickies.bind("add",this.addOne);Stickies.bind("reset",this.addAll);Boards.bind("change:title",this.didChangeTitle);StickyContextMenuView.initialize();j(document).bind("paste",this.manipulateClipboard);j(document).bind("dblclick",this.createSticky)},setReadonly:function(){j(this.el).undelegate(".board_title","click")},changeBoardTitle:function(b){if(j("#fallr:visible").length){return}var a=["<p>Enter a new title:</p>",'<input type="text" id="new_title" class="editing" />'];j("#fallr").removeAttr("style");j.fallr("show",{zIndex:parseInt(j(".actions").css("z-index"))-2,closeKey:true,closeOverlay:true,position:"400px",buttons:{button1:{text:"Continue",onclick:function(){var c=j(this).find("#new_title").val();if(c!=""){currentBoard.set({title:c}).save()}j.fallr("hide")}},button2:{text:"Cancel"}},content:a.join(""),icon:"form"},function(){j("#new_title").keydown(function(c){if(c.keyCode==13){j("#fallr-button-button1").trigger("click")}}).focus()})},didChangeTitle:function(a,b){j(".board_title").text(b);j(".boards_window").find("li[data-id="+a.id+"] .title").text(b)},menuHoverFx:function(a){j(a.currentTarget).animate({color:"#fff"},"fast")},menuLeaveFx:function(a){j(a.currentTarget).animate({color:"#ccc"},"fast")},openBoardsWindow:function(a){a.preventDefault();if(_.isUndefined(this.boardsView)){this.boardsView=new BoardsView().render()}this.boardsView.open()},openUserVoice:function(a){a.preventDefault();UserVoice.showPopupWidget()},manipulateClipboard:function(b){var d=b.originalEvent.clipboardData,a=d.getData("text/html")||d.getData("text/plain"),c=j("<p/>").html(a).text();j(b.target).append(c);b.preventDefault()},addOne:function(c){var b=new StickyView({model:c}).render();var a=j(b.el).appendTo(".stickies").css({top:c.get("position_y"),left:c.get("position_x")}).show()},addAll:function(){Stickies.each(this.addOne);setTimeout(function(){j(".sticky").css("height","auto")},2000)},createSticky:function(b){if(Quadro.readonly){return}var a=new StickyView({model:new Sticky}).render();if(b.type=="dblclick"){if(b.target!=document.body){return}j(a.el).css({top:b.layerY,left:b.layerX})}j(a.el).appendTo(".stickies").fadeIn(function(){j(this).css({height:"auto"})}).css("zIndex",zIndexMax());b.preventDefault()},render:function(){j(this.el).html(this.template());if(!Quadro.readonly){this.shareMenuView=new ShareMenuView().render();j(this.el).find(".right").parent().before(this.shareMenuView.el)}return this}});var ShareMenuView=Backbone.View.extend({tagName:"li",template:JST["boards/share"],events:{"click .share":"toggleSubmenu","click #share_public":"makeBoardPublic","keypress #username":"lookupUsername","click .destroy_relationship":"destroyCollaboration"},initialize:function(){_.bindAll(this,"render","toggleSubmenu","makeBoardPublic","lookupUsername","destroyCollaboration","closeSubmenu");currentBoard.collaborators.bind("add",this.render);j(document).bind("click",this.closeSubmenu)},closeSubmenu:function(a){if(!j(a.target).parents(".actions").length){j(this.el).find(".share_menu:not(:animated)").fadeOut("fast")}},destroyCollaboration:function(c){var b=j(c.currentTarget).parent(),d=b.data("id"),a=currentBoard.collaborators.get(d);a.destroy({success:function(){b.fadeOut("fast",function(){b.remove()})}});currentBoard.collaborators.remove(a);c.preventDefault()},lookupUsername:function(c){if(c.keyCode==13){var d=j(c.currentTarget).val().replace(/@/g,""),b=(d!==""&&d!==Quadro.nickname),a=currentBoard.collaborators.detect(function(e){return e.get("nickname").toLowerCase()==d.toLowerCase()});if(!a&&b){currentBoard.collaborators.create({username:d},{error:function(){console.log(this);console.log(arguments)}})}}},toggleSubmenu:function(a){a.preventDefault();j(this.el).find(".share_menu").fadeToggle("fast")},makeBoardPublic:function(b){var a=b.currentTarget.checked;currentBoard.set({share_public:a}).save()},render:function(){var a=j(this.el).find(".share_menu:visible").length;j(this.el).html(this.template(currentBoard.toJSON()));if(arguments.length&&a){j(this.el).find(".share_menu").show()}return this}});var Sticky=Backbone.Model.extend({defaults:{title:"Untitled",content:"Click here to start writing something useful. You can also change the background color using the right mouse button.",position_x:100,position_y:100,color:"yellow",z_index:0},url:function(){return"/boards/"+currentBoard.id+"/stickies"+(this.isNew()?"":"/"+this.id)},toJSON:function(){var a=_.clone(this.attributes);return _.extend(a,{cid:_.bind(function(){return this.cid.match(/\d+/)[0]},this),formattedContent:function(){return formatContent(this.content)}})}});var StickyCollection=Backbone.Collection.extend({model:Sticky}),Stickies=window.Stickies=new StickyCollection;Stickies.url=function(){return"/boards/"+currentBoard.id+"/stickies"};var StickyView=Backbone.View.extend({className:"sticky",template:JST["stickies/sticky"],events:{"click .remove":"remove","focus .title, .content":"setContentEditable","blur .title, .content":"unsetContentEditable","keypress .title":"didChangeTitle",contextmenu:"openContextMenu",dragstop:"updateStickyPosition",dragstart:"closeContextMenu",click:"bringToFront"},initialize:function(){_.bindAll(this,"render","setContentEditable","unsetContentEditable","remove","didChangeTitle","openContextMenu","closeContextMenu","bringToFront")},bringToFront:function(c){var b=j(this.el).css("z-index"),a=zIndexMax();if(parseInt(b)!=a-1&&isOverlapping(j(this.el))){this.model.set({z_index:a}).save();j(this.el).css("zIndex",a)}},openContextMenu:function(a){a.preventDefault();StickyContextMenuView.context(this).open(a.pageX,a.pageY)},closeContextMenu:function(){StickyContextMenuView.close()},didChangeTitle:function(a){return a.which!=13},updateStickyPosition:function(b,c){var a=this;this.model.set({position_x:c.offset.left,position_y:c.offset.top}).save({},{error:function(d,e){if(e.statusText!=="abort"){a.close()}}})},setContentEditable:function(b){var a=j(b.currentTarget);if(a.text()==this.model.defaults.title||a.text()==this.model.defaults.content){a.text("");setSelection(b.currentTarget)}a.removeClass("unselectable").attr("contenteditable","true");b.preventDefault()},unsetContentEditable:function(c){var b=[],d=j(this.el).find(".title").text(),a=j(this.el).find(".content p");j(c.currentTarget).addClass("unselectable").attr("contenteditable","false");if(a.length){a.each(function(){b.push(j(this).text())});b=b.join("\n")}else{b=j(this.el).find(".content").text()}if(!j.trim(d).length){d=this.model.defaults.title;j(this.el).find(".title").text(d)}if(!j.trim(b).length){b=this.model.defaults.content;j(this.el).find(".content").empty().append(j("<p/>").text(b))}if(this.model.get("title")!==d||this.model.get("content")!==b){this.model.set({title:d,content:b}).save()}},close:function(){j(this.el).fadeOut(function(){j(this).remove()})},remove:function(b){var a=this;if(b&&"preventDefault" in b){b.preventDefault()}this.model.destroy({success:function(){a.close()}});if(this.model.isNew()){this.close()}},render:function(){j(this.el).addClass(this.model.get("color")).html(this.template(this.model.toJSON())).css({position:"absolute",zIndex:this.model.get("z_index")}).draggable({containment:"window",cancel:".title, .content",stack:".sticky"});if(Quadro.readonly){j(this.el).unbind();j(this.el).find(".remove").remove()}if(j(".sticky:last").hasClass("even")==false){j(this.el).addClass("even")}return this}});var StickyContextMenuView={availableColors:["blue","green","pink","purple","gray"],template:JST["stickies/colors"],initialize:function(){_.bindAll(this,"changeColor","close");this.el=j(this.template()).prependTo("#app");this.el.find("li").bind("click",this.changeColor);j(document).bind("click",this.close)},changeColor:function(c){var b=this,a=j(c.currentTarget).data("color");_.each(this.availableColors,function(d){j(b.sticky.el).removeClass(d)});this.sticky.model.set({color:a}).save();j(this.sticky.el).addClass(this.sticky.model.get("color"))},context:function(a){this.sticky=a;return this},open:function(a,b){this.el.css({top:b,left:a,zIndex:998}).fadeIn(1)},close:function(){this.el.fadeOut("fast")}};var Collaborator=Backbone.Model.extend({}),CollaboratorCollection=Backbone.Collection.extend({model:Collaborator});var Board=Backbone.Model.extend({urlRoot:"/boards",defaults:{title:"Untitled",share_public:false},initialize:function(){this.collaborators=new CollaboratorCollection;this.collaborators.url="/boards/"+this.id+"/collaborators";this.collaborators.reset(this.attributes.collaborators)},toJSON:function(){var a=_.clone(this.attributes);a.collaborators=this.collaborators.toJSON();return a}});var BoardCollection=Backbone.Collection.extend({model:Board}),Boards=window.Boards=new BoardCollection,currentBoard=null;var BoardsView=Backbone.View.extend({className:"boards-window",template:JST["boards/boards"],events:{"click .new_board":"createBoard","click .destroy_board":"removeBoard","click .boards-items li":"selectItem"},initialize:function(){_.bindAll(this,"render","openBoard","createBoard","removeBoard","selectItem")},selectItem:function(a){j(a.currentTarget).siblings().removeClass("selected");j(a.currentTarget).addClass("selected")},openBoard:function(){var a=j(".boards-items").find(".selected"),b=this;if(a.length){var c=a.data("id");currentBoard=Boards.get(c);Stickies.fetch({success:function(e,d){j(".stickies").empty();j(".board_title").text(currentBoard.get("title"));e.trigger("reset");b.close()}});Quadro.views.workspaceView.shareMenuView.render(true)}},createBoard:function(a){var b=prompt("Enter a title:");if(b==""||b==null){return}Boards.create({title:b},{success:function(d,c,f){var e=JST["boards/board"].call(d.toJSON());j(e).css("display","none").appendTo(".boards-items").slideDown()}})},removeBoard:function(){var a=j(".boards-items").find(".selected");if(a.length){var d=a.data("id"),b=Boards.get(d),c=confirm("Are you sure?");if(c){b.destroy({success:function(f,e){a.slideUp()},error:function(f,h,g){var e=JSON.parse(h.responseText);alert(e.message)}})}}},open:function(){if(j("#fallr:visible").length){return}j.fallr("show",{zIndex:parseInt(j(".actions").css("z-index"))+1,closeKey:true,closeOverlay:true,icon:"basket",width:"320px",height:"280px",position:"center",content:j(this.render().el).clone(true),buttons:{button1:{className:"new-icon",text:"New",onclick:this.createBoard},button2:{className:"open-icon",text:"Open",onclick:this.openBoard},button3:{className:"remove-icon",text:"Delete",onclick:this.removeBoard}}});j("#fallr").css({width:"265px",padding:"15px"});j("#fallr-buttons").css("position","absolute")},close:function(){j.fallr("hide")},render:function(){this.boards=Boards.map(function(a){return JST["boards/board"].call(a.toJSON())});j(this.el).html(this.template({boards:this.boards}));return this}});var currentRequests={};j.ajaxPrefilter(function(a,d,c){var b=j("meta[name='csrf-token']").attr("content");if(currentRequests[a.url]){currentRequests[a.url].abort()}c.setRequestHeader("X-CSRF-Token",b);currentRequests[a.url]=c});j.ajaxSetup({beforeSend:function(){if(j(".workspace:visible").length){j(".mini_loader").css("visibility","visible")}},complete:function(){if(j(".workspace:visible").length){j(".mini_loader").css("visibility","hidden")}}});window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;console.log(Array.prototype.slice.call(arguments))}};function formatContent(a){var b=j("<div/>");_.each(a.split("\n"),function(c){var d=j("<p/>");if(c==""){d.html("<br>")}else{d.text(c)}d.appendTo(b)});return b.html()}function zIndexMax(){var a=0;j(".sticky").each(function(){var b=parseInt(j(this).css("z-index"));if(b>a){a=b}});return a+1}function setSelection(a){setTimeout(function(){var c,b;if(window.getSelection&&document.createRange){b=document.createRange();b.selectNodeContents(a);b.collapse(true);c=window.getSelection();c.removeAllRanges();c.addRange(b)}else{if(document.body.createTextRange){b=document.body.createTextRange();b.moveToElementText(a);b.collapse(true);b.select()}}},1)}function isOverlapping(c){var d=j(".sticky").not(c),b=c.offset(),a=false;d.each(function(){var e=j(this).offset();if(Math.abs(e.top-b.top)<=j(this).outerHeight()&&Math.abs(e.left-b.left)<=j(this).outerWidth()){a=true}});return a}j(function(){_.extend(Quadro,{readonly:j(document.body).data("readonly"),board_id:j(document.body).data("board-id")});if(Quadro.authenticated||Quadro.readonly){currentBoard=Boards.get(Quadro.board_id)||Boards.first();Quadro.views.workspaceView=new WorkspaceView().render();j(Quadro.views.workspaceView.el).prependTo("#app");if(Quadro.readonly){Quadro.views.workspaceView.setReadonly()}Stickies.trigger("reset")}else{Quadro.views.loginView=new LoginView().render();j(Quadro.views.loginView.el).prependTo("#app")}j(window).load(function(){j("#loading").fadeOut()})});